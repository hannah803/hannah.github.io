---
layout: post
title: 苹果的隐私云计算（PCC）做了什么
---

Created: 2024-06-11 14:06
> TL;DR
> 
> PCC引入了苹果端侧的安全机制，以及一些模糊用户身份的机制，并不涉及隐私计算，数据还是会暴露给最终处理请求的那方。

2024年6月11日凌晨，苹果WWDC大会如期而至，除了Vision Pro将于6月28日在中国区发售、iPhone终于能够通话录音、以及iPad终于有了计算器这些“亮点”以外，Apple Intelligence无疑是此次大会的重中之重。

Apple Intelligence将生成式模型内置在iPhone、iPad和Mac中，能够为用户提供基于个人情境（Personal Context）的智能协助，可以轻松处理“调出上周xx发我的文件”，“看看xxx的照片”以及“播放前几天我妻子发给我的播客”等诸如此类的任务。当一些任务无法由运行在端侧的模型满足时，则会使用隐私云计算（Private Cloud Computing，PCC）技术引入基于服务器的模型或者OpenAI的能力来解决。

而这一举措受到了马斯克的激烈批评，表示苹果在操作系统层面集成OpenAI是不可接受的安全违背。
![Pasted image 20240611150402.png](https://s2.loli.net/2024/06/13/Dk5inujWVEhC3ZB.png)
![image.png](https://s2.loli.net/2024/06/13/r6f1DinhTdZuIBU.png)

那么PCC是否能够保证用户的数据和隐私不被泄露呢？目前网络上可以搜索到的关于PCC的技术细节来自由 Apple 安全工程和架构 (SEAR)、用户隐私、核心操作系统 (Core OS)、服务工程 (ASE) 以及机器学习和人工智能 (AIML) 团队共同撰写的一篇[博客](https://security.apple.com/blog/private-cloud-compute/)，下面我们一起来详细解读一下。

## Part 1 - 传统云安全措施面临的挑战
长久以来，苹果坚持用户数据都只存在于端侧设备，若数据需要上云（如iMessage服务），则会采用端到端加密的方式存储于云上，保证数据仍旧只能被用户看到。若端到端加密方案不适用，则只能传统的云安全措施，例如在不相关的随机标识符下处理用户数据，以掩盖用户身份，最大化保证用户隐私。

云上的大模型需要用户的请求和附带的个人数据进行**未加密的访问**，因此端到端加密方案无法使用，而传统的云安全措施又面临以下几点挑战：

1. 云上的安全和隐私措施难以验证和执行，安全研究人员无法验证云服务声称的关于用户数据的处理措施是否执行；
2. 云服务的运行是不透明的，即使云服务使用开源软件，安全人员也无法确认正在运行的是未经修改的版本；
3. 云 AI 环境下很难实现强权限访问限制，云人工智能服务的大规模运行性能和其他运行指标需要由工程师和云服务提供商的管理人员进行持续监控，故障期间管理员通常可以使用高权限访问服务，对这类高权限访问施加访问控制极其困难。

## Part 2 - PCC要满足的核心要求
1. 用户数据的无状态计算。保证用户数据只用来满足用户的请求，用户个人数据不会在PCC系统里留痕。
2. 可执行的保证。
3. PCC不包含任何特权接口。
4. 攻击者无法在不攻击整个PCC系统的情况下获取到目标用户个人数据。
5. 安全研究员需要能够验证PCC实现了声称的安全和隐私。

## Part3 - PCC 节点
PCC的信任根是PCC节点。PCC节点是定制的采用与iPhone中使用相同硬件安全技术（Secure Enclave、Secure Boot）的服务器硬件（将苹果芯片的安全能力和强大性能引入数据中心），搭配iOS和macOS的基础强化子集组成的操作系统，以支持LLM推理负载，这种配置使得PCC节点能够利用代码签名、沙箱等iOS安全技术。

在此基础上，PCC构建了一组自定义的云扩展。为了应对Part 1中的第3点挑战，PCC将传统数据中心管理中的一些组件，如远程shell访问和系统调试工具，替换为专门构建的、确定性地仅向 SRE 员工提供小部分有限操作的组件。

此外，PCC 使用 Swift on Server 构建了一个新的机器学习栈，专门用于托管基于云的基础模型。

下面来详细看下针对每个目标，PCC都做了什么。

### 无状态计算和可执行的保证
PCC 计算节点必须在处理过程中对用户数据的隐私实施技术保证，并且在其工作周期完成后必须无法保留用户数据。
- 当Apple Intelligence调用PCC时，设备端侧的PCC客户端将要发送给云端模型的请求（提示词、选择的模型和推理参数）用**PCC计算节点的公钥加密**，这提供了PCC客户端和PCC计算节点间的端到端加密，确保请求不会在传输过程中被PCC计算节点外的实体（如支持数据中心的服务，比如负载均衡和隐私网关等）访问；PCC计算节点使用Secure Boot和Code Signing保证私钥安全和授权代码执行，在节点上运行的所有代码都必须**已由 Apple 签名、批准用于该特定 PCC 节点，并由 Secure Enclave 加载**，以确保代码在运行时无法被更改或修改，同时确保无法创建 JIT 映射，从而防止在运行时编译或注入新代码。此外，所有代码和模型资产都使用与 [Signed System Volume](https://support.apple.com/guide/security/signed-system-volume-security-secd698747c9/web)相同的完整性保护。最后，Secure Enclave保证用于解密请求的密钥不能被复制或提取。
- PCC软件栈确保用户请求执行完后不会在存储在他处。Secure Enclave 在每次重新启动时会随机化数据卷的加密密钥，并且不会保留这些随机密钥，从而确保写入数据卷的数据在重新启动后不会保留。换句话说，每次 PCC 节点的 Secure Enclave 处理器重新启动时，都可以强制保证数据卷被加密擦除。 PCC 节点上的推理进程在执行完成后会删除与请求关联的数据，并且定期回收用于处理用户数据的地址空间，以限制可能意外保留在内存中的任何数据的影响。
- 防绕过机制。指针认证代码 [Pointer Authentication Codes](https://support.apple.com/guide/security/operating-system-integrity-sec8b776536b/1/web/1#sec0167b469d)(PAC) 用来防止对内存损坏错误的利用， Swift语言编写推理控制和调度层，确保内存安全，并使用单独的地址空间来隔离请求的初始处理。内存安全和最小特权原则的结合消除了对推理栈本身的所有类型的攻击，并限制了成功攻击可以获得的控制级别和能力。

### 无特权运行时访问
确保不允许任何人绕过上一节中无状态计算的安全保证。
- 不在 PCC 节点上包含远程 shell 或交互式调试机制。尽管Code Signing机制可以防止此类机制加载额外的代码，但远程shell等开放式访问会扩大攻击面。PCC无法启用开发者模式，也不包含任何调试工具
- 构建系统的可观察性和管理工具，只有预先指定的、结构化的和经过审核的日志和指标才能离开节点，并且提供多个独立的审查层以防止用户数据意外泄露。

### 无目标性
威胁模型假设攻击者能够物理访问到PCC计算节点，也就是攻击者有能力攻击硬件的某些安全特性并从计算节点中提取正在处理的数据。防御措施包括：
- 加固 PCC 硬件供应链来补充苹果芯片的内置保护功能；
	- 在每台服务器密封之前对 PCC 节点的组件进行清点和高分辨率成像，并启动防篡改开关；
	- 服务器运抵数据中心后进行大量的重新验证，多个 Apple 团队交叉检查独立来源的数据，同时过程中受第三方观察员监控；
	- 最后为每个 PCC 节点 Secure Enclave UID 中的密钥颁发证书
- 确保小规模攻击不能用于攻击特定用户的数据；PCC使用target diffusion方法来确保不会根据用户或者请求内容而将请求路由到特定节点
	- 在请求元数据中不包含任何能够识别个人身份的信息（如消息的源设备、用户），只包含有限的上下文数据
	- 元数据中包含**RSA盲签名**作为一次性身份凭证
	- 隐藏 ip - PCC 请求由第三方运营的 OHTTP 中继，该中继在请求到达 PCC 基础结构之前隐藏设备的源 IP 地址

### 可验证的透明度
允许安全研究人员验证PCC端到端安全和隐私保证。
- 公开 PCC 每个生产环境下的二进制软件镜像
- 在仅附加且加密防篡改的透明日志中发布在 PCC 上运行的所有代码的情况（what measurements？）。
- PCC节点用密码学方式证明运行的软件是公开的版本（how？）

此外，为方便安全研究者
- 发布PCC虚拟研究环境
- 定期发布关键PCC源代码子集
- PCC镜像将包括sepOS固件和iBoot引导加载程序

## 总结
对于有安全背景的人来说，这些措施都不让人意外，也并不能让人放心。不过苹果承诺的为方便安全研究者而公开的一些工具和代码，倒是能让研究员们有事情干了，可以预见接下来的顶会一定会有这个topic的研究出来，期待一下。最后说个很直观的想法，要让一些在意又不那么懂的用户放心，可能可以给用户提供一个很方便知道哪些信息被发送给到云端的界面，以及一个保证所有请求在发往云端前都会征得用户同意的技术方案，会更能说服目前持怀疑态度的人。不过这对于安全研究员来说，并不解决任何问题。

另：有观点认为，在隐私计算主流方案中，和同态加密、多方安全计算、零知识证明等隐私计算不同，TEE 是一种基于硬件层面的隐私机密计算，属于最可靠的一种。

那么，PCC这套方案算是通过可信执行环境（TEE）来实现隐私计算吗？是的。

够了吗？不。

## Reference
- [智东西 - 苹果AI一夜颠覆所有！Siri史诗级进化，内挂ChatGPT-4o，奥特曼来了，马斯克怒了](https://mp.weixin.qq.com/s/OswemHVWeqCqTrQGT8cA_g)
- [Blog - Private Cloud Compute: A new frontier for AI privacy in the cloud - Apple Security Research](https://security.apple.com/blog/private-cloud-compute/)